<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Royal Ops Room</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ops Royal (Navy & Gold) ================= */
        :root {
            --primary: #0f172a;      /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ Ø¹Ù…ÙŠÙ‚ */
            --accent: #1e293b;       /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ ÙØ§ØªØ­ */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --bg: #f1f5f9;           /* Ø®Ù„ÙÙŠØ© Ù‡Ø§Ø¯Ø¦Ø© */
            --panel: #ffffff;        /* ÙƒØ±ÙˆØª Ø¨ÙŠØ¶Ø§Ø¡ */
            --text: #334155;         /* Ù†Øµ Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text); user-select: none; overflow-x: hidden; 
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ */
        .navbar { 
            background: var(--primary); height: 70px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; 
            box-shadow: 0 4px 20px rgba(15, 23, 42, 0.15); 
            position: sticky; top: 0; z-index: 1000; 
            border-bottom: 3px solid var(--gold); 
        }
        .brand { font-size: 22px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        
        /* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .live-stats-bar { display: flex; gap: 20px; }
        .stat-box { 
            background: rgba(255,255,255,0.08); 
            padding: 5px 20px; border-radius: 12px; 
            text-align: center; border: 1px solid rgba(255,255,255,0.1); 
        }
        .stat-val { font-weight: bold; font-size: 16px; color: var(--gold); }
        .stat-lbl { font-size: 11px; color: #94a3b8; }

        /* ØªØ®Ø·ÙŠØ· Ø§Ù„Ø´Ø§Ø´Ø© */
        .ops-container { display: grid; grid-template-columns: 70% 30%; height: calc(100vh - 73px); }
        
        /* Ø§Ù„Ø±Ø§Ø¯Ø§Ø± (Ø§Ù„ÙŠÙ…ÙŠÙ†) */
        .live-section { 
            padding: 25px; overflow-y: auto; 
            border-left: 1px solid #e2e8f0; 
            background: #f8fafc; 
        }
        
        /* Ø§Ù„ØªØ­ÙƒÙ… (Ø§Ù„ÙŠØ³Ø§Ø±) */
        .manual-section { 
            background: white; 
            padding: 25px; overflow-y: auto; 
            box-shadow: -5px 0 20px rgba(0,0,0,0.03); 
        }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .card { 
            background: white; border-radius: 16px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.03); 
            margin-bottom: 25px; 
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        .card-header { 
            padding: 15px 20px; font-size: 15px; font-weight: 800; 
            color: var(--primary); 
            display: flex; justify-content: space-between; align-items: center; 
            background: #f8fafc; border-bottom: 1px solid #e2e8f0; 
        }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        thead { background: #f1f5f9; color: var(--text); position: sticky; top: 0; z-index: 10; }
        th { padding: 15px; text-align: right; font-weight: 700; color: #64748b; border-bottom: 1px solid #e2e8f0; }
        td { padding: 15px; text-align: right; border-bottom: 1px solid #f1f5f9; color: var(--primary); font-weight: 500; }
        tr { transition: 0.2s; }
        tr:hover { background-color: #f8fafc; }

        /* Ø¥Ø¶Ø§Ø¡Ø© Ù†Ø§Ø¹Ù…Ø© */
        @keyframes softPulse {
            0% { box-shadow: inset 0 0 0 transparent; background: white; }
            50% { box-shadow: inset 5px 0 0 var(--gold); background: #fffbeb; }
            100% { box-shadow: inset 0 0 0 transparent; background: white; }
        }
        .new-order-active { animation: softPulse 2s infinite; border-left: 4px solid var(--gold); }
        .urgent-order { border-left: 4px solid var(--danger); background: #fef2f2; }

        /* Ø§Ù„Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£Ù†ÙŠÙ‚Ø© */
        .badge { padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 12px; display: inline-block; }
        
        .bg-money { background: #ecfdf5; color: var(--success); border: 1px solid #a7f3d0; } /* Ø³Ø¹Ø± Ø§Ù„Ø·Ù„Ø¨ */
        .bg-fee { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; } /* Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„ */
        
        .bg-phone { background: #fff7ed; color: #ea580c; border: 1px solid #fed7aa; font-family: monospace; letter-spacing: 0.5px; }
        .bg-time { color: #94a3b8; font-size: 12px; font-weight: 600; }
        .bg-shop { font-weight: 800; color: var(--primary); font-size: 14px; }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø¬Ù†Ø¨ Ø¨Ø¹Ø¶) */
        .financial-cell {
            display: flex; gap: 8px; justify-content: flex-end; align-items: center;
        }

        /* Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ (ØµØ­) */
        .btn-ack { 
            background: white; color: #cbd5e1; border: 2px solid #e2e8f0; 
            width: 32px; height: 32px; border-radius: 50%; 
            cursor: pointer; display: flex; align-items: center; justify-content: center; 
            font-size: 16px; transition: 0.2s; 
        }
        .btn-ack:hover { border-color: var(--success); color: var(--success); transform: scale(1.1); }
        .row-acked .btn-ack { background: var(--success); border-color: var(--success); color: white; cursor: default; }
        .row-acked { opacity: 0.5; background: #f8fafc !important; animation: none !important; border-left: 4px solid #cbd5e1 !important; filter: grayscale(100%); }

        /* ÙÙˆØ±Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
        .manual-form { display: flex; flex-direction: column; gap: 15px; padding: 20px; }
        input { 
            padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 12px; 
            outline: none; background: #f8fafc; color: var(--primary); 
            width: 100%; box-sizing: border-box; transition: 0.3s; font-weight: 600;
        }
        input:focus { border-color: var(--primary); background: white; }
        
        .btn-whatsapp { 
            background: var(--primary); color: white; border: none; 
            padding: 15px; border-radius: 12px; font-weight: 700; 
            cursor: pointer; transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 10px; 
            font-size: 14px; box-shadow: 0 4px 10px rgba(15, 23, 42, 0.15);
        }
        .btn-whatsapp:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(15, 23, 42, 0.2); }

        .mini-btn { background: none; border: none; cursor: pointer; font-size: 16px; opacity: 0.5; transition: 0.2s; }
        .mini-btn:hover { opacity: 1; transform: scale(1.2); }

        .memory-hint { font-size: 11px; color: var(--gold); background: #fffbeb; padding: 8px; border-radius: 8px; display: none; margin-top: -10px; border: 1px solid #fde68a; }

        @media (max-width: 900px) { .ops-container { grid-template-columns: 1fr; height: auto; } .live-section { border-left: none; } }
    </style>
</head>
<body onclick="Ops_EnableSound()">

    <audio id="Ops_NotifSound" preload="auto" loop>
        <source src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" type="audio/mpeg">
    </audio>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Ops</div>
        
        <div class="live-stats-bar">
            <div class="stat-box">
                <div class="stat-val" id="Ops_StatTotal">0</div>
                <div class="stat-lbl">Ø§Ù„Ø·Ù„Ø¨Ø§Øª</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="Ops_StatPending" style="color:var(--danger);">0</div>
                <div class="stat-lbl">Ø§Ù†ØªØ¸Ø§Ø±</div>
            </div>
            <div class="stat-box">
                <div class="stat-val" id="Ops_StatComm">0.00</div>
                <div class="stat-lbl">Ø¹Ù…ÙˆÙ„Ø©</div>
            </div>
        </div>
    </nav>

    <div class="ops-container">
        
        <div class="live-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“¡ Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Live Radar)</span>
                    <span style="font-size:11px; color:#94a3b8;">Ù…ØªØµÙ„ ğŸŸ¢</span>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width:50px;">ØªÙ…</th>
                            <th>Ø§Ù„ÙˆÙ‚Øª</th>
                            <th>Ù…Ù†Ø°</th>
                            <th>Ø§Ù„Ù…ØµØ¯Ø±</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø·Ù„Ø¨ + Ø§Ù„ØªÙˆØµÙŠÙ„)</th>
                            <th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
                        </tr>
                    </thead>
                    <tbody id="Ops_LiveTableBody">
                        <tr><td colspan="7" style="text-align:center; padding:30px; color:#94a3b8;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="manual-section">
            <div class="card">
                <div class="card-header">
                    <span>ğŸ“² ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ù„ÙƒÙŠØ©</span>
                </div>
                
                <div class="manual-form">
                    <div>
                        <input type="tel" id="Ops_ManPhone" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† (07xxxxxxxx)" oninput="Ops_CheckCapMemory()">
                        <div id="Ops_MemHint" class="memory-hint"> Ø§Ù„Ø¨Ø·Ù„: <span id="Ops_MemName"></span></div>
                    </div>

                    <input type="text" id="Ops_ManCapName" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ†">
                    <input type="text" id="Ops_ManRestName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†Ø´Ø£Ø©">
                    
                    <div style="display:flex; gap:10px;">
                        <input type="number" id="Ops_ManVal" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <input type="number" id="Ops_ManFee" placeholder="Ø§Ù„ØªÙˆØµÙŠÙ„">
                    </div>

                    <div style="display:flex; gap:10px;">
                        <input type="number" id="Ops_ManRatio" placeholder="Ù†Ø³Ø¨Ø© %">
                    </div>

                    <button class="btn-whatsapp" onclick="Ops_SendManualOrder()">
                        <span>Ø¥Ø±Ø³Ø§Ù„ ÙˆØªÙˆØ«ÙŠÙ‚</span> ğŸš€
                    </button>
                    
                    <input type="hidden" id="Ops_EditModeIndex" value="-1">
                    <button id="Ops_CancelEditBtn" onclick="Ops_CancelEdit()" style="display:none; background:#64748b; border:none; padding:10px; border-radius:10px; color:white; cursor:pointer; font-weight:bold;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <span>ğŸ—‚ï¸ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ</span>
                    <button onclick="Ops_ClearArchive()" class="mini-btn" style="color:var(--danger);" title="ØªØµÙÙŠØ±">ğŸ—‘ï¸</button>
                </div>
                <div style="padding:10px;">
                    <table style="font-size:11px;">
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ†</th>
                                <th>Ø§Ù„Ù…ÙƒØ§Ù†</th>
                                <th>Ø¹Ù…ÙˆÙ„Ø©</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="Ops_ArchiveBody">
                            <tr><td colspan="4" style="text-align:center; color:#94a3b8;">ÙØ§Ø±Øº</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ========================================================
        // ÙƒÙˆØ¯ Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ø§Ù„Ù…Ø§Ø³ÙŠ - v10.0 (Diamond Edition) Ø§Ù„Ù…Ø´ÙØ±
        // ========================================================
        
        if (typeof Core_N_ONE_CORE !== 'undefined') {
            Core_N_ONE_CORE.Core_API_URL = "https://script.google.com/macros/s/AKfycbxFVz0QTi_7TgWQEMImtMGYRBzlD1CwM5X4DbprUvVJkURs_75aD5n5IcpbS87d8Q5j/exec";
        }

        let Ops_AllData = [];
        // Ø°Ø§ÙƒØ±Ø© Ø¯Ø§Ø¦Ù…Ø© Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¤ÙƒØ¯Ø©
        let Ops_AckedSet = new Set(JSON.parse(localStorage.getItem('Ops_AckedOrders') || '[]'));
        
        let Ops_SoundEnabled = false;
        let Ops_IsAlarmPlaying = false;
        let Ops_CaptainMemory = JSON.parse(localStorage.getItem('Ops_CaptainsDB') || '{}');
        let Ops_DailyArchive = JSON.parse(localStorage.getItem('Ops_DailyArchiveDB') || '[]');

        window.onload = async function() {
            await Ops_FetchData();
            Ops_RenderArchive();
            setInterval(Ops_FetchDataSilent, 5000);
            setInterval(Ops_UpdateTimers, 1000);
        };

        function Ops_EnableSound() {
            if (!Ops_SoundEnabled) {
                const Ops_Audio = document.getElementById('Ops_NotifSound');
                Ops_Audio.play().then(() => { 
                    Ops_Audio.pause(); Ops_Audio.currentTime = 0; Ops_SoundEnabled = true; 
                }).catch(() => {});
            }
        }

        function Ops_PlayAlarm() {
            const Ops_Audio = document.getElementById('Ops_NotifSound');
            if (Ops_SoundEnabled && !Ops_IsAlarmPlaying) {
                Ops_Audio.loop = true; Ops_Audio.play().catch(()=>{}); Ops_IsAlarmPlaying = true;
            }
        }

        function Ops_StopAlarm() {
            const Ops_Audio = document.getElementById('Ops_NotifSound');
            Ops_Audio.pause(); Ops_Audio.currentTime = 0; Ops_IsAlarmPlaying = false;
        }

        async function Ops_FetchData() {
            try { Ops_AllData = await Core_N_ONE_CORE.Core_fetchData('read'); Ops_RenderLiveTable(); } catch (Ops_E) {}
        }

        async function Ops_FetchDataSilent() {
            try {
                const Ops_NewData = await Core_N_ONE_CORE.Core_fetchData('read');
                if (Ops_NewData.length > 0) { Ops_AllData = Ops_NewData; Ops_RenderLiveTable(); }
            } catch (Ops_E) {}
        }

        function Ops_RenderLiveTable() {
            const Ops_Tbody = document.getElementById('Ops_LiveTableBody');
            const Ops_Orders = Ops_AllData.filter(i => i.type === 'order' || i.Auth_Type === 'order').reverse();
            
            document.getElementById('Ops_StatTotal').innerText = Ops_Orders.length;
            
            // Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ø§Ù„Ù…Ø¤ÙƒØ¯ÙŠÙ†
            const Ops_PendingCount = Ops_Orders.filter(o => !Ops_AckedSet.has(o.id || o.Auth_ID)).length;
            document.getElementById('Ops_StatPending').innerText = Ops_PendingCount;
            
            if (Ops_PendingCount > 0) Ops_PlayAlarm(); else Ops_StopAlarm();

            if (Ops_Orders.length === 0) { Ops_Tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding:30px; color:#94a3b8;">Ø§Ù„Ø±Ø§Ø¯Ø§Ø± Ù‡Ø§Ø¯Ø¦...</td></tr>'; return; }
            
            Ops_Tbody.innerHTML = '';
            
            Ops_Orders.forEach(Ops_Ord => {
                const Ops_OrderID = Ops_Ord.id || Ops_Ord.Auth_ID;
                const Ops_IsAck = Ops_AckedSet.has(Ops_OrderID);
                
                let Ops_RowClass = '';
                const Ops_OrderDate = Ops_Ord.date || Ops_Ord.Auth_Date;
                const Ops_OrderTime = new Date(Ops_OrderDate).getTime();
                const Ops_Now = Date.now();
                const Ops_DiffSec = Math.floor((Ops_Now - Ops_OrderTime) / 1000);
                
                if (Ops_IsAck) {
                    Ops_RowClass = 'row-acked';
                } else {
                    if (Ops_DiffSec > 120) Ops_RowClass = 'urgent-order';
                    else Ops_RowClass = 'new-order-active';
                }

                const Ops_AckIcon = Ops_IsAck ? 'âœ”' : 'âœ“';
                
                // === Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ===
                let Ops_ShopPhone = Ops_Ord.cap_phone || Ops_Ord.Auth_CapPhone;
                const Ops_ClientUser = Ops_Ord.client_user || Ops_Ord.Auth_ClientUser;

                if (!Ops_ShopPhone || Ops_ShopPhone === "ØºÙŠØ± Ù…Ø³Ø¬Ù„") {
                    const Ops_UserRecord = Ops_AllData.find(u => (u.user === Ops_ClientUser || u.Auth_User === Ops_ClientUser) && (u.type === 'shop' || u.Auth_Type === 'shop'));
                    if (Ops_UserRecord && (Ops_UserRecord.cap_phone || Ops_UserRecord.Auth_CapPhone)) Ops_ShopPhone = Ops_UserRecord.cap_phone || Ops_UserRecord.Auth_CapPhone;
                    else Ops_ShopPhone = "---";
                }
                
                let Ops_ShopLocLink = '#';
                const Ops_PickupLoc = Ops_Ord.pickup || Ops_Ord.Auth_Pickup;
                if (Ops_PickupLoc && Ops_PickupLoc.includes('http')) Ops_ShopLocLink = Ops_PickupLoc;
                else if (Ops_PickupLoc) Ops_ShopLocLink = `http://googleusercontent.com/maps.google.com/search?q=${encodeURIComponent(Ops_PickupLoc)}`;

                const Ops_TimeObj = new Date(Ops_OrderDate);
                const Ops_ExactTime = Ops_TimeObj.toLocaleTimeString('en-US', {hour12:false}); 

                const Ops_ClientNameDisplay = Ops_Ord.cl_name || Ops_Ord.Auth_ClName || '---';
                const Ops_ValDisplay = Ops_Ord.val || Ops_Ord.Auth_Val;
                const Ops_FeeDisplay = Ops_Ord.fee || Ops_Ord.Auth_Fee;

                Ops_Tbody.innerHTML += `
                    <tr class="${Ops_RowClass}" id="Ops_Row_${Ops_OrderID}" data-time="${Ops_OrderTime}" data-ack="${Ops_IsAck}">
                        <td>
                            <button class="btn-ack" onclick="Ops_AckOrder('${Ops_OrderID}')">${Ops_AckIcon}</button>
                        </td>
                        <td class="bg-time">${Ops_ExactTime}</td>
                        <td><span class="timer-badge" id="Ops_Timer_${Ops_OrderID}" style="color:${Ops_IsAck ? '#cbd5e1' : 'var(--gold)'}">0s</span></td>
                        <td class="bg-shop">${Ops_ClientNameDisplay}</td>
                        <td><span class="badge bg-phone">${Ops_ShopPhone}</span></td>
                        <td>
                            <div class="financial-cell">
                                <span class="badge bg-money" title="Ù‚ÙŠÙ…Ø© Ø§Ù„Ø·Ù„Ø¨">${Ops_ValDisplay} Ø¯.Ø£</span>
                                <span class="badge bg-fee" title="Ø§Ù„ØªÙˆØµÙŠÙ„">+ ${Ops_FeeDisplay}</span>
                            </div>
                        </td>
                        <td><a href="${Ops_ShopLocLink}" target="_blank" class="badge" style="background:#e0f2fe; color:#0284c7; text-decoration:none;">ğŸ“ Ø®Ø±ÙŠØ·Ø©</a></td>
                    </tr>
                `;
            });
            Ops_UpdateTimers();
        }

        function Ops_AckOrder(Ops_ID) {
            Ops_AckedSet.add(Ops_ID);
            localStorage.setItem('Ops_AckedOrders', JSON.stringify(Array.from(Ops_AckedSet)));
            Ops_RenderLiveTable(); 
        }

        function Ops_UpdateTimers() {
            const Ops_Rows = document.querySelectorAll('tbody tr');
            Ops_Rows.forEach(Ops_Row => {
                const Ops_Time = Ops_Row.getAttribute('data-time');
                const Ops_IsAck = Ops_Row.getAttribute('data-ack') === 'true';
                const Ops_RowID = Ops_Row.id.replace('Ops_Row_', '');
                
                if (Ops_Time) {
                    const Ops_Diff = Math.floor((Date.now() - parseInt(Ops_Time)) / 1000);
                    const Ops_TimerEl = document.getElementById(`Ops_Timer_${Ops_RowID}`);
                    if (Ops_TimerEl) {
                        Ops_TimerEl.innerText = Ops_Diff + "s";
                        if (Ops_Diff > 120 && !Ops_IsAck) Ops_TimerEl.style.color = "var(--danger)";
                    }
                    if (!Ops_IsAck && Ops_Diff > 120 && !Ops_Row.classList.contains('urgent-order')) {
                        Ops_Row.classList.remove('new-order-active');
                        Ops_Row.classList.add('urgent-order');
                    }
                }
            });
        }

        // ================= Ø§Ù„Ù…Ø±Ø³Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ =================
        function Ops_CheckCapMemory() {
            const Ops_Phone = document.getElementById('Ops_ManPhone').value;
            const Ops_Hint = document.getElementById('Ops_MemHint');
            if (Ops_CaptainMemory[Ops_Phone]) {
                Ops_Hint.style.display = 'block';
                document.getElementById('Ops_MemName').innerText = Ops_CaptainMemory[Ops_Phone];
                document.getElementById('Ops_ManCapName').value = Ops_CaptainMemory[Ops_Phone];
            } else Ops_Hint.style.display = 'none';
        }

        function Ops_SendManualOrder() {
            const Ops_Phone = document.getElementById('Ops_ManPhone').value;
            const Ops_CapName = document.getElementById('Ops_ManCapName').value;
            const Ops_RestName = document.getElementById('Ops_ManRestName').value;
            const Ops_Val = document.getElementById('Ops_ManVal').value;
            const Ops_Fee = document.getElementById('Ops_ManFee').value;
            const Ops_Ratio = document.getElementById('Ops_ManRatio').value || 0;
            const Ops_EditIndex = document.getElementById('Ops_EditModeIndex').value;

            if (!Ops_Phone || !Ops_RestName) { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©"); return; }

            if (Ops_CapName) {
                Ops_CaptainMemory[Ops_Phone] = Ops_CapName;
                localStorage.setItem('Ops_CaptainsDB', JSON.stringify(Ops_CaptainMemory));
            }

            const Ops_CapOrders = Ops_DailyArchive.filter(o => o.cap === Ops_CapName);
            const Ops_TodayCount = Ops_CapOrders.length + 1; 
            let Ops_TodayEarnings = Ops_CapOrders.reduce((Ops_Sum, o) => Ops_Sum + parseFloat(o.fee || 0), 0);
            Ops_TodayEarnings += parseFloat(Ops_Fee || 0);

            const Ops_MapLink = `http://googleusercontent.com/maps.google.com/search?q=${encodeURIComponent(Ops_RestName)}`;
            
            let Ops_FinalPhone = Ops_Phone.startsWith('0') ? '962' + Ops_Phone.substring(1) : Ops_Phone;
            if (!Ops_FinalPhone.startsWith('962')) Ops_FinalPhone = '962' + Ops_Phone;

            const Ops_Msg = `ÙŠØ§ Ù‡Ù„Ø§ Ø¨Ù€ *${Ops_CapName}* Ø§Ù„Ø¨Ø·Ù„ ğŸ¦¸â€â™‚ï¸%0a` +
                        `ÙŠØ³Ø¹Ø¯Ù†Ø§ Ù†Ø¨Ù„ØºÙƒ Ø¥Ù†Ù‡ ÙˆØµÙ„Ùƒ Ø£ÙˆØ±Ø¯Ø± Ø¬Ø¯ÙŠØ¯ ğŸš€%0a` +
                        `-----------------------------%0a` +
                        `ğŸª Ø§Ù„Ù…Ù†Ø´Ø£Ø©: *${Ops_RestName}*%0a` +
                        `ğŸ“ Ø§Ù„Ù„ÙˆÙƒÙŠØ´Ù†: ${Ops_MapLink}%0a` +
                        `ğŸ›µ Ø§Ù„ØªÙˆØµÙŠÙ„: *${Ops_Fee} Ø¯.Ø£*%0a` +
                        `ğŸ’° Ø§Ù„Ù‚ÙŠÙ…Ø©: *${Ops_Val} Ø¯.Ø£*%0a` +
                        `-----------------------------%0a` +
                        `ğŸ“Š Ø§Ù„ÙŠÙˆÙ…: *${Ops_TodayCount}* | ğŸ’µ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: *${Ops_TodayEarnings.toFixed(2)} Ø¯.Ø£*`;

            if (confirm("Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨ØŸ")) {
                window.open(`https://wa.me/${Ops_FinalPhone}?text=${Ops_Msg}`, '_blank');
            }

            const Ops_Commission = (parseFloat(Ops_Fee || 0) * (parseFloat(Ops_Ratio) / 100)).toFixed(2);
            const Ops_Entry = { cap: Ops_CapName, phone: Ops_Phone, rest: Ops_RestName, val: Ops_Val, fee: Ops_Fee, ratio: Ops_Ratio, comm: Ops_Commission };

            if (Ops_EditIndex > -1) { Ops_DailyArchive[Ops_EditIndex] = Ops_Entry; Ops_CancelEdit(); } 
            else { Ops_DailyArchive.unshift(Ops_Entry); }
            
            document.getElementById('Ops_ManRestName').value = '';
            document.getElementById('Ops_ManVal').value = '';
            document.getElementById('Ops_ManFee').value = '';
            
            localStorage.setItem('Ops_DailyArchiveDB', JSON.stringify(Ops_DailyArchive));
            Ops_RenderArchive();
        }

        function Ops_RenderArchive() {
            const Ops_Tbody = document.getElementById('Ops_ArchiveBody');
            let Ops_TotalComm = 0;
            if (Ops_DailyArchive.length === 0) { Ops_Tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#94a3b8;">ÙØ§Ø±Øº</td></tr>'; } 
            else {
                Ops_Tbody.innerHTML = '';
                Ops_DailyArchive.forEach((Ops_Item, Ops_Index) => {
                    Ops_TotalComm += parseFloat(Ops_Item.comm);
                    Ops_Tbody.innerHTML += `
                        <tr>
                            <td>${Ops_Item.cap}</td>
                            <td>${Ops_Item.rest}</td>
                            <td style="color:var(--success); font-weight:bold;">${Ops_Item.comm}</td>
                            <td><button class="mini-btn" onclick="Ops_DeleteItem(${Ops_Index})" style="color:var(--danger);">Ã—</button></td>
                        </tr>`;
                });
            }
            document.getElementById('Ops_StatComm').innerText = Ops_TotalComm.toFixed(2);
        }

        function Ops_DeleteItem(Ops_Index) { if(confirm("Ø­Ø°ÙØŸ")) { Ops_DailyArchive.splice(Ops_Index, 1); Ops_SaveAndRender(); } }
        function Ops_EditItem(Ops_Index) { 
            const Ops_Item = Ops_DailyArchive[Ops_Index];
            document.getElementById('Ops_ManPhone').value = Ops_Item.phone;
            document.getElementById('Ops_ManCapName').value = Ops_Item.cap;
            document.getElementById('Ops_ManRestName').value = Ops_Item.rest;
            document.getElementById('Ops_ManVal').value = Ops_Item.val;
            document.getElementById('Ops_ManFee').value = Ops_Item.fee;
            document.getElementById('Ops_ManRatio').value = Ops_Item.ratio;
            document.getElementById('Ops_EditModeIndex').value = Ops_Index;
            document.getElementById('Ops_CancelEditBtn').style.display = 'block';
            document.querySelector('.btn-whatsapp span').innerText = "Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª"; 
        }
        function Ops_CancelEdit() { 
            document.getElementById('Ops_EditModeIndex').value = "-1";
            document.getElementById('Ops_CancelEditBtn').style.display = 'none';
            document.querySelector('.btn-whatsapp span').innerText = "Ø¥Ø±Ø³Ø§Ù„ ÙˆØªÙˆØ«ÙŠÙ‚";
            document.getElementById('Ops_ManRestName').value = '';
            document.getElementById('Ops_ManVal').value = '';
            document.getElementById('Ops_ManFee').value = '';
        }
        function Ops_ClearArchive() { if(confirm("ØªØµÙÙŠØ±ØŸ")) { Ops_DailyArchive = []; Ops_SaveAndRender(); } }
        function Ops_SaveAndRender() { localStorage.setItem('Ops_DailyArchiveDB', JSON.stringify(Ops_DailyArchive)); Ops_RenderArchive(); }
    </script>
</body>
</html>
