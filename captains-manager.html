<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Royal Fleet)</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ops Royal (Navy & Gold) - ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ù‡ÙˆÙŠØ© ================= */
        :root {
            --primary: #0f172a;      /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ Ø¹Ù…ÙŠÙ‚ (Ù…Ø«Ù„ Ops Room) */
            --accent: #1e293b;       /* Ù†ÙŠÙÙŠ Ø¨Ù„Ùˆ ÙØ§ØªØ­ */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --bg: #0f172a;           /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙƒÙ†Ø© */
            --panel: #1e293b;        /* ÙƒØ±ÙˆØª Ø±Ù…Ø§Ø¯ÙŠØ© Ù…Ø²Ø±Ù‚Ø© */
            --text: #e2e8f0;         /* Ù†Øµ ÙØ§ØªØ­ */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± */
            --warning: #f59e0b;      /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù„Ù„Ù†Ø¬ÙˆÙ… */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); margin: 0; padding: 0; 
            color: var(--text); user-select: none; 
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ù„ÙƒÙŠ */
        .navbar { 
            background: rgba(15, 23, 42, 0.95); height: 70px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; border-bottom: 2px solid var(--gold); 
            position: sticky; top: 0; z-index: 1000; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .brand { font-size: 24px; font-weight: 900; color: white; letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        
        .nav-tools button {
            background: var(--accent); color: white; border: 1px solid #334155;
            padding: 8px 15px; border-radius: 8px; cursor: pointer; transition: 0.3s; margin-left: 5px;
        }
        .nav-tools button:hover { border-color: var(--gold); color: var(--gold); }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }

        /* Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª */
        .card { 
            background: var(--panel); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.3); 
            margin-bottom: 25px; border: 1px solid #334155;
            overflow: hidden;
        }
        .card-header { 
            padding: 20px; background: rgba(0,0,0,0.2); border-bottom: 1px solid #334155;
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 18px; font-weight: 800; color: var(--gold); display: flex; align-items: center; gap: 10px; }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        thead { background: rgba(0,0,0,0.3); }
        th { padding: 15px; text-align: right; color: #94a3b8; font-weight: bold; border-bottom: 2px solid #334155; }
        td { padding: 15px; border-bottom: 1px solid #334155; color: var(--text); }
        tr:hover { background: rgba(255,255,255,0.05); }

        /* Ø§Ù„Ø´Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
        .badge { padding: 5px 10px; border-radius: 6px; font-size: 12px; font-weight: bold; }
        .bg-active { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .bg-paused { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        
        .stars { color: var(--warning); letter-spacing: 2px; }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ØµØºØ±Ø© */
        .action-btn { 
            background: none; border: none; cursor: pointer; font-size: 16px; 
            padding: 5px; opacity: 0.7; transition: 0.2s; 
        }
        .action-btn:hover { opacity: 1; transform: scale(1.2); }

        /* ======= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø± (Merchant Mode) ======= */
        #merchant-view { display: none; }
        .merchant-dashboard {
            background: linear-gradient(135deg, #004d40, #00695c);
            padding: 30px; border-radius: 20px; color: white;
            text-align: center; margin-bottom: 30px; border: 2px solid var(--gold);
        }
        .merchant-input {
            padding: 15px; border-radius: 10px; border: none; width: 60%;
            margin: 10px 0; font-size: 16px; text-align: center;
        }

        /* ======= ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Print Report) ======= */
        #report-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; 
        }
        .report-paper {
            background: white; color: black; width: 210mm; height: 90vh; 
            padding: 40px; overflow-y: auto; border-radius: 5px;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); position: relative;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© */
        @media print {
            body * { visibility: hidden; }
            #report-modal, #report-modal * { visibility: visible; }
            #report-modal { position: absolute; left: 0; top: 0; background: white; width: 100%; height: 100%; }
            .report-paper { box-shadow: none; width: 100%; height: auto; overflow: visible; }
            .no-print { display: none !important; }
        }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Fleet Ops</div>
        <div class="nav-tools">
            <button onclick="toggleMerchantMode()">ğŸª ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø± (Ù…Ø­Ø§ÙƒØ§Ø©)</button>
            <button onclick="window.close()" style="border-color:var(--danger); color:var(--danger);">Ø¥ØºÙ„Ø§Ù‚ âŒ</button>
        </div>
    </nav>

    <div class="container">

        <div id="admin-view">
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:20px; margin-bottom:20px;">
                <div class="card" style="padding:20px; text-align:center; border-top:4px solid var(--success);">
                    <h3 style="margin:0; color:#94a3b8;">Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</h3>
                    <h1 id="total-wallet" style="color:var(--success); margin:10px 0;">0.00</h1>
                    <small style="color:var(--gold);">Ø¯.Ø£</small>
                </div>
                <div class="card" style="padding:20px; text-align:center; border-top:4px solid var(--primary);">
                    <h3 style="margin:0; color:#94a3b8;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„</h3>
                    <h1 id="total-caps" style="color:white; margin:10px 0;">0</h1>
                    <small>ÙƒØ§Ø¨ØªÙ†</small>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ‘®â€â™‚ï¸ Ø³Ø¬Ù„ Ø§Ù„ÙƒØ¨Ø§ØªÙ† ÙˆØ§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠ</div>
                    <input type="text" id="search-cap" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† ÙƒØ§Ø¨ØªÙ†..." oninput="renderCaptains()" 
                           style="padding:8px; border-radius:8px; border:none; background:#334155; color:white;">
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ù†Ø¬ÙˆÙ…)</th>
                            <th>Ø§Ù„ØªØ±Ù…ÙŠØ² / Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ù…Ø­ÙØ¸Ø© (Ø¯.Ø£)</th>
                            <th>Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ØªØ­ÙƒÙ…</th>
                        </tr>
                    </thead>
                    <tbody id="captains-body">
                        <tr><td colspan="6" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div id="merchant-view">
            <div class="merchant-dashboard">
                <h2 style="color:var(--gold);">âš¡ Ù†Ù‚Ø·Ø© Ø´Ø­Ù† Ù…Ø¹ØªÙ…Ø¯Ø© (Merchant Point)</h2>
                <p>Ø±ØµÙŠØ¯ Ø§Ù„Ù…Ù†Ø´Ø£Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ: <span style="font-weight:bold; font-size:20px;">500.00 Ø¯.Ø£</span></p>
                <hr style="border-color:rgba(255,255,255,0.2); margin:20px 0;">
                
                <h3>Ø´Ø­Ù† Ø±ØµÙŠØ¯ ÙƒØ§Ø¨ØªÙ†</h3>
                <input type="text" id="merch-cap-id" class="merchant-input" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø£Ùˆ Ù‡Ø§ØªÙÙ‡" onchange="findCaptainForMerchant()">
                <div id="merch-cap-name" style="font-weight:bold; margin:10px; color:var(--gold);">...</div>
                
                <input type="number" id="merch-amount" class="merchant-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)">
                <br>
                <button onclick="merchantCharge()" style="padding:15px 40px; background:var(--gold); border:none; border-radius:10px; font-weight:bold; cursor:pointer; font-size:18px; color:black; margin-top:15px;">Ø¥ØªÙ…Ø§Ù… Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø­Ù† âœ…</button>
                <br><br>
                <button onclick="toggleMerchantMode()" style="background:none; border:none; color:white; text-decoration:underline; cursor:pointer;">Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
            </div>
        </div>

    </div>

    <div id="report-modal">
        <div class="report-paper">
            <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:20px; margin-bottom:20px;">
                <h1 style="margin:0;">N One Global Systems</h1>
                <p style="margin:5px;">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ ÙƒØ§Ø¨ØªÙ† (Captain Statement)</p>
                <p style="font-size:12px; color:#555;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span id="rep-date"></span></p>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:20px; background:#f9f9f9; padding:15px; border-radius:10px;">
                <div>
                    <strong>Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</strong> <span id="rep-name">---</span><br>
                    <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="rep-phone">---</span>
                </div>
                <div style="text-align:left;">
                    <strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="rep-balance" style="font-size:18px;">0.00</span> Ø¯.Ø£<br>
                    <strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:</strong> <span id="rep-stars">â­â­â­â­â­</span>
                </div>
            </div>

            <table style="width:100%; border:1px solid #ddd; color:black;">
                <thead style="background:#eee; color:black;">
                    <tr>
                        <th style="color:black; border:1px solid #ddd;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="color:black; border:1px solid #ddd;">Ø§Ù„Ù†ÙˆØ¹</th>
                        <th style="color:black; border:1px solid #ddd;">Ø§Ù„Ø¨ÙŠØ§Ù†</th>
                        <th style="color:black; border:1px solid #ddd;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    </tr>
                </thead>
                <tbody id="rep-body">
                    </tbody>
            </table>

            <div style="margin-top:30px; border-top:1px solid #ddd; padding-top:10px; display:flex; justify-content:space-between;">
                <div>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ / Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</div>
                <div>N One Approved âœ…</div>
            </div>

            <button class="no-print" onclick="window.print()" style="position:absolute; top:20px; right:20px; padding:10px 20px; background:black; color:white; border:none; cursor:pointer;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
            <button class="no-print" onclick="closeReport()" style="position:absolute; top:20px; right:100px; padding:10px 20px; background:red; color:white; border:none; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // ========================================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø³ÙŠØ·Ø±Ø© v8.0 (The Admiral) âš“
        // ========================================================
        
        if (typeof N_ONE_CORE !== 'undefined') {
            N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        }

        let captainsList = [];
        let globalOrders = [];

        window.onload = async function() {
            await loadAllData();
        };

        async function loadAllData() {
            try {
                const data = await N_ONE_CORE.fetchData('read');
                captainsList = data.filter(i => i.type === 'captain');
                globalOrders = data.filter(i => i.type === 'order'); // Ù„Ø¬Ù„Ø¨ Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                
                renderCaptains();
                updateStats();
            } catch (e) { console.error(e); }
        }

        // 1. Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø¬ÙˆÙ…
        function renderCaptains() {
            const tbody = document.getElementById('captains-body');
            const search = document.getElementById('search-cap').value.toLowerCase();
            tbody.innerHTML = '';

            captainsList.forEach(cap => {
                if(search && !cap.name.toLowerCase().includes(search) && !cap.cap_phone.includes(search)) return;

                // Ù†Ø¸Ø§Ù… Ø§Ù„Ù†Ø¬ÙˆÙ… (Simulation based on balance/activity)
                // ÙÙŠ Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ ÙŠÙ…ÙƒÙ† Ø±Ø¨Ø·Ù‡ Ø¨Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ÙØ¹Ù„ÙŠ Ù…Ù† Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡
                let stars = 'â­â­â­'; 
                const bal = parseFloat(cap.balance || 0);
                if(bal > 50) stars = 'â­â­â­â­â­';
                else if(bal > 20) stars = 'â­â­â­â­';

                const statusBadge = cap.status === 'active' 
                    ? `<span class="badge bg-active">Ù†Ø´Ø·</span>` 
                    : `<span class="badge bg-paused">Ù…Ø¬Ù…Ø¯</span>`;

                const emergencyBadge = (cap.emergency_used === 'true') 
                    ? `<span style="color:var(--danger); font-size:11px;">Ù…Ø³ØªØ®Ø¯Ù… âš ï¸</span>` 
                    : `<span style="color:var(--success); font-size:11px;">Ù…ØªØ§Ø­ âœ…</span>`;

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:bold;">${cap.name}</div>
                            <div class="stars">${stars}</div>
                        </td>
                        <td style="font-family:monospace; color:var(--gold);">${cap.user}<br>${cap.cap_phone}</td>
                        <td style="font-weight:bold; font-size:16px;">${bal.toFixed(2)}</td>
                        <td>${emergencyBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn" onclick="openReport('${cap.user}')" title="ØªÙ‚Ø±ÙŠØ± ÙˆØ·Ø¨Ø§Ø¹Ø©">ğŸ–¨ï¸</button>
                            <button class="action-btn" onclick="manualUpdateBalance('${cap.user}')" title="ØªØ¹Ø¯ÙŠÙ„ Ø±ØµÙŠØ¯" style="color:var(--success);">ğŸ’°</button>
                            <button class="action-btn" onclick="toggleCapStatus('${cap.user}')" title="ØªØ¬Ù…ÙŠØ¯/ØªÙØ¹ÙŠÙ„" style="color:var(--danger);">â„ï¸</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateStats() {
            document.getElementById('total-caps').innerText = captainsList.length;
            const totalBal = captainsList.reduce((sum, c) => sum + parseFloat(c.balance || 0), 0);
            document.getElementById('total-wallet').innerText = totalBal.toFixed(2);
        }

        // 2. Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±ÙŠ
        async function manualUpdateBalance(user) {
            const amount = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„Ø¥Ø¶Ø§ÙØ© (Ø£Ùˆ - Ù„Ù„Ø®ØµÙ…):");
            if(amount) {
                // Ù…Ø­Ø§ÙƒØ§Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ±
                const cap = captainsList.find(c => c.user === user);
                if(cap) {
                    cap.balance = (parseFloat(cap.balance || 0) + parseFloat(amount)).toFixed(2);
                    // Ù‡Ù†Ø§ ÙŠØ¬Ø¨ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ POST Ù„Ù„Ø³ÙŠØ±ÙØ± Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙØ¹Ù„ÙŠØ§Ù‹
                    alert("âœ… ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ø­Ù„ÙŠØ§Ù‹ (ÙŠØ­ØªØ§Ø¬ Ø±Ø¨Ø· Backend Ù„Ù„ØªØ«Ø¨ÙŠØª)");
                    renderCaptains();
                }
            }
        }

        async function toggleCapStatus(user) {
            const cap = captainsList.find(c => c.user === user);
            if(cap) {
                cap.status = cap.status === 'active' ? 'paused' : 'active';
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ÙŠØ±ÙØ±
                await N_ONE_CORE.postData('update', { user: user, data: { status: cap.status } });
                alert("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© ğŸ”„");
                renderCaptains();
            }
        }

        // 3. Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Print Ready)
        function openReport(user) {
            const cap = captainsList.find(c => c.user === user);
            if(!cap) return;

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù‡ÙŠØ¯Ø±
            document.getElementById('rep-name').innerText = cap.name;
            document.getElementById('rep-phone').innerText = cap.cap_phone;
            document.getElementById('rep-balance').innerText = cap.balance || "0.00";
            document.getElementById('rep-date').innerText = new Date().toLocaleDateString();

            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ†)
            const tbody = document.getElementById('rep-body');
            tbody.innerHTML = '';
            
            // ÙÙ„ØªØ±Ø© Ø·Ù„Ø¨Ø§Øª Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Simulation logic: match logic needed in backend)
            // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙÙŠ globalOrdersØŒ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ù†ÙØ°Ù‡Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ†
            // (ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù‚Ø¯ Ù„Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø±Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¨Ø§Ù„ IDØŒ Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø§Ø³Ù… Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø©)
            const capOrders = globalOrders.filter(o => o.cap_name === cap.name || o.cap_phone === cap.cap_phone);

            if(capOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø©</td></tr>';
            } else {
                capOrders.forEach(o => {
                    tbody.innerHTML += `
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;">${o.date.split('T')[0]}</td>
                            <td style="border:1px solid #ddd; padding:8px;">ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨</td>
                            <td style="border:1px solid #ddd; padding:8px;">${o.pickup}</td>
                            <td style="border:1px solid #ddd; padding:8px;">${o.fee} Ø¯.Ø£</td>
                        </tr>
                    `;
                });
            }

            document.getElementById('report-modal').style.display = 'flex';
        }

        function closeReport() {
            document.getElementById('report-modal').style.display = 'none';
        }

        // 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØªØ§Ø¬Ø± (Ù†Ù‚Ø·Ø© Ø§Ù„Ø´Ø­Ù† Ø§Ù„Ù…Ø®ÙÙŠØ©)
        function toggleMerchantMode() {
            const adminView = document.getElementById('admin-view');
            const merchView = document.getElementById('merchant-view');
            
            if(merchView.style.display === 'none' || !merchView.style.display) {
                const pass = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø´Ø­Ù† (Ù„Ù„Ù…Ø­Ø§ÙƒØ§Ø© ÙÙ‚Ø·):");
                if(pass === "555") { // ÙƒÙˆØ¯ Ø³Ø±ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø©
                    adminView.style.display = 'none';
                    merchView.style.display = 'block';
                } else {
                    alert("â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Loader_Point");
                }
            } else {
                adminView.style.display = 'block';
                merchView.style.display = 'none';
            }
        }

        function findCaptainForMerchant() {
            const input = document.getElementById('merch-cap-id').value;
            const cap = captainsList.find(c => c.user === input || c.cap_phone === input);
            const display = document.getElementById('merch-cap-name');
            if(cap) {
                display.innerText = "Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚: " + cap.name;
                display.style.color = "var(--gold)";
            } else {
                display.innerText = "ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ âŒ";
                display.style.color = "red";
            }
        }

        function merchantCharge() {
            const input = document.getElementById('merch-cap-id').value;
            const amount = document.getElementById('merch-amount').value;
            const cap = captainsList.find(c => c.user === input || c.cap_phone === input);
            
            if(cap && amount) {
                if(confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø´Ø­Ù† ${amount} Ø¯.Ø£ Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${cap.name}ØŸ\n(Ø³ÙŠØªÙ… Ø®ØµÙ… Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)`)) {
                    // Ù‡Ù†Ø§ ÙƒÙˆØ¯ Ø§Ù„ API Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ø´Ø­Ù†
                    alert(`âœ… ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\n- Ø±ØµÙŠØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${(parseFloat(cap.balance||0) + parseFloat(amount)).toFixed(2)}\n- Ø¹Ù…ÙˆÙ„Ø© Ø§Ù„Ù…Ù†Ø´Ø£Ø©: +${(amount*0.02).toFixed(2)}`);
                    document.getElementById('merch-cap-id').value = '';
                    document.getElementById('merch-amount').value = '';
                    document.getElementById('merch-cap-name').innerText = '...';
                }
            }
        }

    </script>
</body>
</html>
