<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | ØºØ±ÙØ© Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Fleet Command)</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… N One Diamond Edition ================= */
        :root {
            --primary: #0f172a;      /* ÙƒØ­Ù„ÙŠ Ø¹Ù…ÙŠÙ‚ */
            --secondary: #1e293b;    /* ÙƒØ­Ù„ÙŠ ÙØ§ØªØ­ */
            --accent: #0ea5e9;       /* Ø£Ø²Ø±Ù‚ Ù†ÙØ§Ø« */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --bg: #f1f5f9;           /* Ø®Ù„ÙÙŠØ© Ø±Ù…Ø§Ø¯ÙŠØ© ÙØ§ØªØ­Ø© */
            --text: #334155;         /* Ù†Øµ Ù…Ø±ÙŠØ­ */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± Ø§Ù„Ù†Ø¬Ø§Ø­ */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± Ø§Ù„Ø®Ø·Ø± */
            --white: #ffffff;
        }

        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: var(--bg); margin: 0; padding: 0; color: var(--text); font-size: 13px; }

        /* --- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø§Ø³ÙŠ --- */
        .navbar { 
            background: var(--primary); height: 60px; display: flex; justify-content: space-between; align-items: center; 
            padding: 0 25px; border-bottom: 3px solid var(--gold); box-shadow: 0 4px 20px rgba(0,0,0,0.2); 
            position: sticky; top: 0; z-index: 1000;
        }
        .brand { font-size: 20px; font-weight: 900; color: white; letter-spacing: 1px; }
        .brand span { color: var(--gold); }

        /* Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ© Ø§Ù„Ø­ÙŠØ© */
        .stats-bar { display: flex; gap: 15px; }
        .live-counter { 
            background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 20px; 
            color: #e2e8f0; font-weight: bold; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; gap: 8px;
        }
        .live-counter b { color: var(--accent); font-size: 16px; }
        .live-counter.shops b { color: var(--gold); }

        .btn-header { background: #334155; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-header:hover { background: var(--accent); }
        .btn-danger-header { background: #7f1d1d; color: #fca5a5; } 
        .btn-danger-header:hover { background: var(--danger); color: white; }

        /* --- Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ --- */
        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; display: grid; grid-template-columns: 380px 1fr; gap: 20px; }

        /* Ø§Ù„ÙƒØ±ÙˆØª */
        .card { background: var(--white); border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); padding: 20px; border-top: 4px solid var(--secondary); margin-bottom: 20px; position: relative; }
        .card h3 { margin: 0 0 15px 0; color: var(--primary); font-size: 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; padding-bottom: 10px; }
        
        /* Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
        .form-group { margin-bottom: 12px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 700; color: #64748b; font-size: 11px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; font-weight: 600; font-size: 13px; transition: 0.3s; }
        input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }

        /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
        .btn { width: 100%; padding: 10px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; font-size: 13px; display: flex; justify-content: center; align-items: center; gap: 5px; }
        .btn-primary { background: var(--primary); } .btn-primary:hover { background: #020617; }
        .btn-success { background: var(--success); } .btn-success:hover { background: #047857; }
        .btn-danger { background: var(--danger); } .btn-danger:hover { background: #b91c1c; }
        .btn-gold { background: var(--gold); color: #fff; } .btn-gold:hover { background: #b4932a; }

        /* Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .table-container { overflow-x: auto; background: white; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        thead { background: var(--secondary); color: white; }
        th, td { padding: 12px 15px; text-align: right; border-bottom: 1px solid #f1f5f9; }
        tbody tr:hover { background: #f8fafc; }
        
        .badge { padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: bold; }
        .badge-active { background: #dcfce7; color: #166534; }
        .badge-paused { background: #fee2e2; color: #991b1b; }

        /* Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© */
        #wallet-result { display: none; background: #f0f9ff; padding: 15px; border-radius: 8px; border: 1px solid #bae6fd; margin-bottom: 15px; animation: slideDown 0.3s; }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* --- Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© ÙˆØ§Ù„Ø³Ø¬Ù„Ø§Øª --- */
        @media print {
            .navbar, .controls, .btn, .form-grid { display: none !important; }
            body { background: white; color: black; }
            .card { border: none; box-shadow: none; padding: 0; margin: 0; }
            table { border: 1px solid #000; }
            th, td { border: 1px solid #000; }
        }
        
        #loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 3000; justify-content: center; align-items: center; flex-direction: column; font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

    <div id="loader-overlay">
        <div style="font-size:40px; margin-bottom:10px;">ğŸ›¡ï¸</div>
        <div>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ± Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ...</div>
    </div>

    <nav class="navbar">
        <div class="brand">N <span>One</span> Fleet</div>
        
        <div class="stats-bar">
            <div class="live-counter" title="Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·">
                ğŸ‘®â€â™‚ï¸ ÙƒØ¨Ø§ØªÙ†: <b id="stat-caps">0</b>
            </div>
            <div class="live-counter shops" title="Ø§Ù„Ù…Ù†Ø´Ø¢Øª Ø§Ù„Ù…Ø±Ø¨ÙˆØ·Ø©">
                ğŸª Ù…Ù†Ø´Ø¢Øª: <b id="stat-shops">0</b>
            </div>
        </div>

        <div style="display:flex; gap:10px;">
            <button class="btn-header" onclick="refreshData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­ÙŠ</button>
            <button class="btn-header btn-danger-header" onclick="secureWipe()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª</button>
        </div>
    </nav>

    <div class="container">
        
        <div>
            <div class="card">
                <h3>ğŸ“ ØªØ¹ÙŠÙŠÙ† ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)</h3>
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="reg_name" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)</label>
                    <input type="tel" id="reg_phone" placeholder="07xxxxxxxx" maxlength="10">
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label>ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© (Coding)</label>
                        <input type="text" id="reg_code" placeholder="Ù…Ø«Ù„Ø§Ù‹: K-50" style="border-color:var(--gold);">
                    </div>
                    <div class="form-group">
                        <label>Ù…ÙˆØ¯ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <input type="number" id="reg_model" placeholder="2024">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                    <select id="reg_type">
                        <option value="Ø³ÙŠØ§Ø±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ø³ÙŠØ§Ø±Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© (EV)</option>
                        <option value="Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø²ÙŠÙ†">Ø³ÙŠØ§Ø±Ø© Ø¨Ù†Ø²ÙŠÙ†</option>
                        <option value="Ù‡Ø¬ÙŠÙ†">Ù‡Ø¬ÙŠÙ† (Hybrid)</option>
                        <option value="Ø³ÙƒÙˆØªØ±">Ø³ÙƒÙˆØªØ±</option>
                    </select>
                </div>

                <button class="btn btn-primary" onclick="registerCaptain()">+ Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„Ù‡ÙˆÙŠØ© ÙˆØ¥ØµØ¯Ø§Ø± Ø§Ù„ØªØµØ±ÙŠØ­</button>
            </div>

            <div class="card">
                <h3>ğŸ’¸ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Smart Wallet)</h3>
                
                <div class="form-group">
                    <label>Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (ÙƒØ¨Ø§ØªÙ† / Ù…Ù†Ø´Ø¢Øª)</label>
                    <div style="display:flex; gap:5px;">
                        <input type="tel" id="wallet_phone" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù„Ù„Ø¨Ø­Ø«...">
                        <button class="btn btn-gold" style="width:auto;" onclick="searchEntity()">ğŸ”</button>
                    </div>
                </div>

                <div id="wallet-result">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                        <span id="res_type" style="font-size:10px; background:#fff; padding:2px 6px; border-radius:4px; border:1px solid #ddd;">--</span>
                        <b id="res_balance" style="font-size:18px; color:var(--success);">0.00</b>
                    </div>
                    <h2 id="res_name" style="margin:0; font-size:16px; color:var(--primary);">---</h2>
                    <small id="res_details" style="color:#64748b;">---</small>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)</label>
                    <input type="number" id="wallet_amount" placeholder="0.00">
                </div>

                <div style="display:flex; gap:10px;">
                    <button class="btn btn-success" onclick="updateBalance('add')">ğŸ“¥ Ø¥ÙŠØ¯Ø§Ø¹</button>
                    <button class="btn btn-danger" onclick="updateBalance('deduct')">ğŸ“¤ Ø®ØµÙ…</button>
                </div>
            </div>
            
            <div class="card">
                <h3>ğŸ“Š Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©</h3>
                <canvas id="fleetChart" height="200"></canvas>
            </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:20px;">
            
            <div class="card">
                <h3>â³ ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± (Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©)</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„Ø§Ø³Ù…</th>
                                <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
                            </tr>
                        </thead>
                        <tbody id="requests-body">
                            <tr><td colspan="4" style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="flex-grow:1;">
                <h3>
                    <span>ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø· (Active Fleet)</span>
                    <button class="btn btn-gold" style="width:auto; padding:5px 15px;" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø³Ø¬Ù„</button>
                </h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</th>
                                <th>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</th>
                                <th>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                                <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                                <th>Ø§Ù„Ø±Ø­Ù„Ø§Øª</th>
                                <th>Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</th>
                                <th>ØªØ­ÙƒÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="fleet-body">
                            <tr><td colspan="8" style="text-align:center; padding:30px;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ========================================================
        // Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ù„ØºØ±ÙØ© Ø§Ù„ÙƒØ¨Ø§ØªÙ† v8.0 (Diamond Shift)
        // ========================================================

        if (typeof N_ONE_CORE !== 'undefined') {
            N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        }

        let allData = [];
        let captains = [];
        let shops = [];
        let requests = [];
        let currentEntity = null; // Ø§Ù„ÙƒÙŠØ§Ù† Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…Ø­ÙØ¸Ø© (ÙƒØ§Ø¨ØªÙ† Ø£Ùˆ Ù…Ù†Ø´Ø£Ø©)

        window.onload = async function() {
            if (typeof N_ONE_CORE === 'undefined') { alert("Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ ØºÙŠØ± Ù…ØªØµÙ„!"); return; }
            await refreshData();
            initChart(); // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
        };

        async function refreshData() {
            document.getElementById('loader-overlay').style.display = 'flex';
            try {
                allData = await N_ONE_CORE.fetchData('read');
                processData();
            } catch (e) { console.error(e); }
            document.getElementById('loader-overlay').style.display = 'none';
        }

        function processData() {
            // ÙØ±Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            captains = allData.filter(i => i.type === 'captain' && i.status !== 'pending').reverse();
            requests = allData.filter(i => i.type === 'captain' && i.status === 'pending');
            shops = allData.filter(i => i.type === 'shop' || i.role === 'shop'); // Ø³Ø­Ø¨ Ø§Ù„Ø®ÙŠÙˆØ· Ù…Ù† Ø§Ù„Ù…Ù†Ø´Ø¢Øª

            // 5. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø­ÙŠØ©
            document.getElementById('stat-caps').innerText = captains.length;
            document.getElementById('stat-shops').innerText = shops.length;

            renderFleet();
            renderRequests();
            updateChart();
        }

        // --- 1. Ù†Ø¸Ø§Ù… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ¨Ø§ØªÙ† (Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
        async function registerCaptain() {
            const name = document.getElementById('reg_name').value;
            const phone = document.getElementById('reg_phone').value;
            const code = document.getElementById('reg_code').value; // ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø©
            const carModel = document.getElementById('reg_model').value;
            const carType = document.getElementById('reg_type').value;

            if(!name || !phone || !code) { alert("ÙŠØ±Ø¬Ù‰ Ø¥ÙƒÙ…Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© â˜ºï¸"); return; }

            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… (Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ)
            const exists = captains.some(c => c.cap_phone === phone) || shops.some(s => s.cap_phone === phone);
            if(exists) { alert("â›” Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…!"); return; }

            document.getElementById('loader-overlay').style.display = 'flex';
            
            const newCap = {
                id: "CAP_" + Date.now(),
                user: code, // Ø­ÙØ¸ ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠ Ø®Ø§Ù†Ø© User
                name: name,
                pass: "123456", // ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
                type: "captain",
                role: "captain",
                cap_phone: phone, // Ø§Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ù‡Ø§ØªÙ
                status: "active",
                pickup: `${carType} - ${carModel}`, // Ø¯Ù…Ø¬ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ù…ÙˆØ¯ÙŠÙ„
                balance: 0,
                emergency_used: "false",
                orders_count: 0 // Ø³Ø¬Ù„ Ø§Ù„Ø±Ø­Ù„Ø§Øª
            };

            await N_ONE_CORE.postData('add', [newCap]);
            alert("ØªÙ… Ø¥ØµØ¯Ø§Ø± Ø§Ù„ØªØµØ±ÙŠØ­ ÙˆØ§Ø¹ØªÙ…Ø§Ø¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ† âœ…");
            
            // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('reg_name').value = '';
            document.getElementById('reg_phone').value = '';
            document.getElementById('reg_code').value = '';
            
            await refreshData();
        }

        // --- 2. Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø© ÙˆØ§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ù…Ù†Ø´Ø¢Øª ---
        function searchEntity() {
            const phone = document.getElementById('wallet_phone').value.trim();
            if(!phone) return;

            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„ÙƒØ¨Ø§ØªÙ† Ø£ÙˆÙ„Ø§Ù‹
            let found = captains.find(c => c.cap_phone === phone);
            let type = "ÙƒØ§Ø¨ØªÙ† ğŸ‘®â€â™‚ï¸";

            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø§Ø¨Ø­Ø« ÙÙŠ Ø®ÙŠÙˆØ· Ø§Ù„Ù…Ù†Ø´Ø¢Øª
            if(!found) {
                found = shops.find(s => s.cap_phone === phone); // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø®ÙŠØ· Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø­ÙˆØ¨
                type = "Ù…Ù†Ø´Ø£Ø© ØªØ¬Ø§Ø±ÙŠØ© ğŸª";
            }

            const resDiv = document.getElementById('wallet-result');
            
            if(found) {
                currentEntity = found;
                resDiv.style.display = 'block';
                document.getElementById('res_type').innerText = type;
                document.getElementById('res_name').innerText = found.name;
                document.getElementById('res_balance').innerText = parseFloat(found.balance || 0).toFixed(2) + " Ø¯.Ø£";
                
                // Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
                if(type.includes("ÙƒØ§Ø¨ØªÙ†")) {
                    document.getElementById('res_details').innerText = `Ø§Ù„ØªØ±Ù…ÙŠØ²: ${found.user} | Ø§Ù„Ù…Ø±ÙƒØ¨Ø©: ${found.pickup}`;
                } else {
                    document.getElementById('res_details').innerText = `Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${found.pickup || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
                }
            } else {
                alert("âŒ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØ©");
                resDiv.style.display = 'none';
                currentEntity = null;
            }
        }

        async function updateBalance(action) {
            if(!currentEntity) return alert("ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ Ø£ÙˆÙ„Ø§Ù‹");
            
            const amount = parseFloat(document.getElementById('wallet_amount').value);
            if(!amount || amount <= 0) return alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºØ§Ù‹ ØµØ­ÙŠØ­Ø§Ù‹");

            const currentBal = parseFloat(currentEntity.balance || 0);
            const newBal = action === 'add' ? currentBal + amount : currentBal - amount;

            if(!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ${action === 'add' ? 'Ø¥ÙŠØ¯Ø§Ø¹' : 'Ø®ØµÙ…'} Ù…Ø¨Ù„Øº ${amount} Ø¯.Ø£ØŸ\nØ§Ù„Ù…Ø³ØªÙÙŠØ¯: ${currentEntity.name}\nØ§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newBal}`)) return;

            document.getElementById('loader-overlay').style.display = 'flex';
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
            await N_ONE_CORE.postData('update', { 
                user: currentEntity.user, 
                data: { balance: newBal } 
            });

            // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙˆÙ„ÙƒÙ† Ù…ÙØ¶Ù„ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©)
            // Ù‡Ù†Ø§ Ù†ÙƒØªÙÙŠ Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ù„Ù„Ø³Ø±Ø¹Ø© Ø­Ø³Ø¨ Ø·Ù„Ø¨ "Ø§Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ø³Ø±ÙŠØ¹Ø©"
            
            alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ ğŸ’°");
            document.getElementById('wallet_amount').value = '';
            document.getElementById('wallet-result').style.display = 'none';
            currentEntity = null;
            
            await refreshData();
        }

        // --- 3. Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø· ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
        function renderFleet() {
            const tbody = document.getElementById('fleet-body');
            tbody.innerHTML = '';

            if(captains.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒØ¨Ø§ØªÙ† Ù†Ø´Ø·ÙŠÙ† Ø­Ø§Ù„ÙŠØ§Ù‹</td></tr>';
                return;
            }

            captains.forEach(c => {
                const statusBadge = c.emergency_used === 'true' 
                    ? '<span class="badge badge-paused">Ø·ÙˆØ§Ø±Ø¦ âš ï¸</span>' 
                    : '<span class="badge badge-active">Ù…Ø³ØªØ¹Ø¯ âœ…</span>';
                
                tbody.innerHTML += `
                    <tr>
                        <td style="font-weight:bold; color:var(--gold);">${c.user}</td>
                        <td>${c.name}</td>
                        <td style="direction:ltr;">${c.cap_phone}</td>
                        <td>${c.pickup || '-'}</td>
                        <td style="font-weight:bold; color:var(--success);">${parseFloat(c.balance||0).toFixed(2)}</td>
                        <td>${c.orders_count || 0}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="btn btn-danger" style="width:auto; padding:2px 8px; font-size:10px;" onclick="deleteCaptain('${c.user}')">âŒ</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function deleteCaptain(u) {
            if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
            document.getElementById('loader-overlay').style.display = 'flex';
            await N_ONE_CORE.fetchData('delete', { user: u });
            await refreshData();
        }

        // --- 4. ØºØ±ÙØ© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ---
        function renderRequests() {
            const tbody = document.getElementById('requests-body');
            tbody.innerHTML = '';
            if(requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:#aaa;">Ø§Ù„ØºØ±ÙØ© ÙØ§Ø±ØºØ© ÙˆÙ‡Ø§Ø¯Ø¦Ø© ğŸ˜Œ</td></tr>';
                return;
            }
            requests.forEach(r => {
                tbody.innerHTML += `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.cap_phone}</td>
                        <td>${r.pickup}</td>
                        <td>
                            <button class="btn btn-success" onclick="approveReq('${r.user}')">Ù‚Ø¨ÙˆÙ„ ÙˆØªØ´ÙÙŠØ± âœ…</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function approveReq(u) {
            const newCode = prompt("ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ù…Ø«Ù„Ø§Ù‹ K-10):");
            if(!newCode) return;
            
            document.getElementById('loader-overlay').style.display = 'flex';
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ±Ù…ÙŠØ² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…ÙƒØ§Ù† Ø§Ù„ÙŠÙˆØ²Ø± Ø§Ù„Ù…Ø¤Ù‚Øª
            // Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„ÙŠÙˆØ²Ø± Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§ØªØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®ØµØ§Ø¦Øµ ÙˆÙ†Ø¹ØªÙ…Ø¯ Ø§Ù„ØªØ±Ù…ÙŠØ² ÙƒØ§Ø³Ù… Ø¹Ø±Ø¶ Ø£Ùˆ Ù†Ù‚ÙˆÙ… Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø®Ù„Ù‚Ù‡.
            // Ù„Ù„ØªØ¨Ø³ÙŠØ· ÙˆØ§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: Ø³Ù†Ø­Ø¯Ø« Ø§Ù„Ø­Ø§Ù„Ø© ÙˆÙ†Ø®Ø²Ù† Ø§Ù„ØªØ±Ù…ÙŠØ² ÙÙŠ Ø­Ù‚Ù„ user Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Ø¸Ø§Ù… ÙŠØ³Ù…Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ØŒ Ø£Ùˆ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ±Ù…ÙŠØ² ÙƒØ§Ø³Ù… Ø¹Ø±Ø¶.
            // Ø§Ù„Ø­Ù„ Ø§Ù„Ø£Ø°ÙƒÙ‰: Ù†Ø³ØªØ®Ø¯Ù… API Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©ØŒ ÙˆÙ†Ø­ÙØ¸ Ø§Ù„ØªØ±Ù…ÙŠØ² ÙÙŠ Ø­Ù‚Ù„ user (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ backend ÙŠØ¯Ø¹Ù…) Ø£Ùˆ Ù†Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„.
            // Ù‡Ù†Ø§ Ø³Ù†ÙØªØ±Ø¶ Ø§Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±:
            await N_ONE_CORE.postData('update', { user: u, data: { status: 'active', user: newCode } }); 
            await refreshData();
        }

        // --- 4.5 ØªØ£Ù…ÙŠÙ† Ø§Ù„Ù…Ø³Ø­ (Security) ---
        async function secureWipe() {
            const pass = prompt("ğŸ”’ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù…Ù†ÙŠ:\nØ£Ø¯Ø®Ù„ Ø´ÙØ±Ø© Ø§Ù„ØªØµØ±ÙŠØ­ Ù„Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª:");
            if (pass === "N1-2026-Security") {
                if(confirm("ØªØ­Ø°ÙŠØ± Ù†ÙˆÙˆÙŠ â˜¢ï¸: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³ÙŠÙˆÙ„Ø© ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©ØŸ")) {
                    document.getElementById('loader-overlay').style.display = 'flex';
                    // Ù†Ù‚ÙˆÙ… Ø¨ÙÙ„ØªØ±Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ­Ø°ÙÙ‡Ø§ (Ù…Ø­Ø§ÙƒØ§Ø© Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„)
                    const ordersToDelete = allData.filter(i => i.type === 'order');
                    // ÙÙŠ Ø¨ÙŠØ¦Ø© Google Apps Script Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©ØŒ Ù†Ø±Ø³Ù„ Ø£Ù…Ø± Ø®Ø§ØµØŒ Ù‡Ù†Ø§ Ø³Ù†Ø­Ø§ÙƒÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
                    alert("ØªÙ… ØªÙ†ÙÙŠØ° Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ Ø§Ù„ØªÙ†Ø¸ÙŠÙ N1. Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¢Ù† Ù†Ø¸ÙŠÙØ© (Ù…Ø­Ø§ÙƒØ§Ø©).");
                    document.getElementById('loader-overlay').style.display = 'none';
                }
            } else {
                alert("â›” Ø´ÙØ±Ø© Ø®Ø§Ø·Ø¦Ø©! ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø®ØªØ±Ø§Ù‚.");
            }
        }

        // --- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© (Chart.js) ---
        let myChart = null;
        function initChart() {
            const ctx = document.getElementById('fleetChart').getContext('2d');
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Ù†Ø´Ø·', 'Ø·ÙˆØ§Ø±Ø¦', 'Ø·Ù„Ø¨Ø§Øª'],
                    datasets: [{
                        data: [0, 0, 0],
                        backgroundColor: ['#10b981', '#ef4444', '#f59e0b'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function updateChart() {
            if(!myChart) return;
            const active = captains.filter(c => c.emergency_used !== 'true').length;
            const emergency = captains.filter(c => c.emergency_used === 'true').length;
            const pending = requests.length;
            
            myChart.data.datasets[0].data = [active, emergency, pending];
            myChart.update();
        }

    </script>
</body>
</html>
