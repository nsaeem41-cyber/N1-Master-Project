<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N One | Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ (Royal Light)</title>
    
    <script src="https://cdn.jsdelivr.net/gh/nsaeem41-cyber/N1-Master-Project@main/n-one-core.js"></script>

    <style>
        /* ================= ØªØµÙ…ÙŠÙ… Ops Room Replica (Royal Light) ================= */
        :root {
            --primary: #0f172a;      /* ÙƒØ­Ù„ÙŠ ØºØ§Ù…Ù‚ (Ù„Ù„Ù‡ÙŠØ¯Ø± ÙˆØ§Ù„Ù†ØµÙˆØµ) */
            --accent: #f8fafc;       /* Ø±Ù…Ø§Ø¯ÙŠ Ø«Ù„Ø¬ÙŠ (Ù„Ù„Ø®Ù„ÙÙŠØ©) */
            --card-bg: #ffffff;      /* Ø£Ø¨ÙŠØ¶ Ù†Ø§ØµØ¹ (Ù„Ù„ÙƒØ±ÙˆØª) */
            --gold: #d4af37;         /* Ø°Ù‡Ø¨ÙŠ Ù…Ù„ÙƒÙŠ */
            --text-main: #334155;    /* Ø±Ù…Ø§Ø¯ÙŠ ØºØ§Ù…Ù‚ Ù„Ù„Ù†ØµÙˆØµ */
            --text-light: #64748b;   /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ù„Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† */
            --success: #10b981;      /* Ø£Ø®Ø¶Ø± */
            --danger: #ef4444;       /* Ø£Ø­Ù…Ø± */
            --warning: #f59e0b;      /* Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ */
            --border: #e2e8f0;       /* Ø­Ø¯ÙˆØ¯ Ù†Ø§Ø¹Ù…Ø© */
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--accent); margin: 0; padding: 0; 
            color: var(--text-main); user-select: none; 
        }

        /* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø£Ù†ÙŠÙ‚ (Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„ØµÙˆØ±Ø©) */
        .navbar { 
            background: var(--card-bg); height: 70px; 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 0 30px; border-bottom: 3px solid var(--gold); 
            position: sticky; top: 0; z-index: 1000; 
            box-shadow: 0 4px 20px rgba(148, 163, 184, 0.15);
        }
        .brand { font-size: 24px; font-weight: 900; color: var(--primary); letter-spacing: 1px; }
        .gold-text { color: var(--gold); }
        
        .btn-close { 
            background: #fef2f2; color: var(--danger); 
            border: 1px solid #fecaca; padding: 8px 15px; 
            border-radius: 8px; cursor: pointer; transition: 0.3s; font-weight: bold;
        }
        .btn-close:hover { background: var(--danger); color: white; }

        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 25px; }

        /* Ø§Ù„ÙƒØ±ÙˆØª Ø§Ù„ÙØ®Ù…Ø© (Shadow & Radius) */
        .card { 
            background: var(--card-bg); border-radius: 16px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); 
            border: 1px solid var(--border); overflow: hidden; 
            transition: transform 0.2s;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 15px 35px rgba(0,0,0,0.06); }
        .card-full { grid-column: span 2; } 

        .card-header { 
            padding: 20px; background: #f8fafc; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        .card-title { font-size: 16px; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 10px; }
        
        .card-body { padding: 25px; }

        /* Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØ§Ù„Ø£Ø²Ø±Ø§Ø± (Clean Style) */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 13px; color: var(--text-light); }
        
        input, select { 
            width: 100%; padding: 12px; border: 2px solid var(--border); border-radius: 12px; 
            outline: none; background: #fafafa; color: var(--primary); font-weight: 600;
            font-size: 14px; box-sizing: border-box; transition: 0.3s; 
        }
        input:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.05); }

        .btn-main { 
            width: 100%; padding: 14px; border: none; border-radius: 12px; 
            font-weight: bold; cursor: pointer; color: white; font-size: 15px; 
            transition: 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .btn-blue { background: var(--primary); } .btn-blue:hover { background: #334155; transform: translateY(-2px); }
        .btn-gold { background: var(--gold); color: white; } .btn-gold:hover { background: #b4932a; transform: translateY(-2px); }
        .btn-green { background: var(--success); } .btn-green:hover { background: #059669; transform: translateY(-2px); }
        .btn-danger { background: var(--danger); } .btn-danger:hover { background: #b91c1c; transform: translateY(-2px); }

        /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ù†ÙŠÙ‚Ø© */
        .table-wrapper { overflow-x: auto; max-height: 400px; }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { padding: 15px; text-align: right; color: var(--text-light); border-bottom: 2px solid var(--border); background: #f8fafc; position: sticky; top: 0; z-index: 10; font-weight: 700; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: var(--primary); font-weight: 500; }
        tr:hover { background: #f8fafc; }

        .badge { padding: 6px 12px; border-radius: 8px; font-size: 11px; font-weight: 800; display: inline-block; }
        .bg-active { background: #ecfdf5; color: var(--success); border: 1px solid #a7f3d0; }
        .bg-pending { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .bg-paused { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
        
        /* Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªØ­ÙƒÙ… */
        .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; padding: 5px; opacity: 0.6; transition: 0.2s; margin-left: 5px; }
        .action-btn:hover { opacity: 1; transform: scale(1.2); }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© Ù„Ù„ØªÙ‚Ø±ÙŠØ± */
        #report-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.8); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .report-paper { background: white; color: black; width: 210mm; height: 90vh; padding: 40px; overflow-y: auto; position: relative; border-radius: 10px; }
        
        @media print {
            body * { visibility: hidden; }
            #report-modal, #report-modal * { visibility: visible; }
            #report-modal { position: absolute; left: 0; top: 0; background: white; width: 100%; height: 100%; }
            .report-paper { width: 100%; height: auto; box-shadow: none; overflow: visible; padding: 0; }
            .no-print { display: none !important; }
        }
        
        /* ØªØ£Ø«ÙŠØ±Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
        #loading-bar { height: 4px; background: var(--gold); width: 0%; position: fixed; top: 70px; left: 0; z-index: 1001; transition: width 0.3s; box-shadow: 0 2px 10px rgba(212, 175, 55, 0.5); }
    </style>
</head>
<body>

    <div id="loading-bar"></div>

    <nav class="navbar">
        <div class="brand">N <span class="gold-text">One</span> Fleet Command ğŸ‘®â€â™‚ï¸</div>
        <div>
            <button onclick="toggleMerchantSim()" style="background:none; border:none; color:#94a3b8; font-size:12px; cursor:pointer; margin-left:10px;">(Merchant Sim)</button>
            <button class="btn-close" onclick="window.close()">Ø¥ØºÙ„Ø§Ù‚ âŒ</button>
        </div>
    </nav>

    <div class="container">

        <div class="card">
            <div class="card-header">
                <div class="card-title">ğŸ“ ØªØ³Ø¬ÙŠÙ„ ÙƒØ§Ø¨ØªÙ† Ø¬Ø¯ÙŠØ¯ (ØªØ¹ÙŠÙŠÙ†)</div>
            </div>
            <div class="card-body">
                <div class="form-group">
                    <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                    <input type="text" id="new_cap_name" placeholder="Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø§Ù„Ø±Ø³Ù…ÙŠ">
                </div>
                <div class="form-group">
                    <label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ (Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨)</label>
                    <input type="tel" id="new_cap_phone" placeholder="07xxxxxxxx">
                </div>
                <div class="form-group">
                    <label>ØªØ±Ù…ÙŠØ² Ø§Ù„Ø³ÙŠØ§Ø±Ø© (User ID / Code)</label>
                    <input type="text" id="new_cap_code" placeholder="Ù…Ø«Ù„Ø§Ù‹: C-101" style="border-color:var(--gold);">
                </div>
                <div style="display:flex; gap:10px;">
                    <div class="form-group" style="flex:1;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</label>
                        <input type="text" id="new_cap_car" placeholder="Ù…Ø«Ù„Ø§Ù‹: Kia">
                    </div>
                    <div class="form-group" style="flex:1;">
                        <label>Ù…ÙˆØ¯ÙŠÙ„</label>
                        <input type="number" id="new_cap_model" placeholder="2020">
                    </div>
                </div>
                <button class="btn-main btn-blue" onclick="registerCaptain()">+ Ø§Ø¹ØªÙ…Ø§Ø¯ ÙˆØªØ¹ÙŠÙŠÙ† (ÙØ­Øµ Ø°ÙƒÙŠ)</button>
            </div>
        </div>

        <div class="card" style="border-top: 4px solid var(--gold);">
            <div class="card-header">
                <div class="card-title">ğŸ’° Ø§Ù„Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø±ÙƒØ²ÙŠ (Live Wallet)</div>
                <label style="display:flex; align-items:center; gap:5px; font-size:12px; cursor:pointer; color:var(--text-light);">
                    <input type="checkbox" id="transfer-toggle" onchange="toggleTransfer()" checked> ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„
                </label>
            </div>
            <div class="card-body">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="wallet_search" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ù€ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„ØªØ±Ù…ÙŠØ²">
                    <button class="btn-main btn-blue" style="width:auto;" onclick="searchWallet()">Ø¨Ø­Ø«</button>
                </div>

                <div id="wallet-info" style="display:none; background:#fffbeb; padding:20px; border-radius:12px; margin-bottom:15px; border:1px solid #fde68a;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span id="w_name" style="font-weight:900; color:var(--primary); font-size:16px;">---</span>
                        <span id="w_balance" style="font-size:24px; font-weight:900; color:#b45309;">0.00 Ø¯.Ø£</span>
                    </div>
                    <div style="font-size:12px; color:#92400e; margin-top:5px;">Code: <span id="w_code">--</span> | Tel: <span id="w_phone">--</span></div>
                </div>

                <div class="form-group">
                    <label>Ø§Ù„Ù…Ø¨Ù„Øº (Ø¯.Ø£)</label>
                    <input type="number" id="wallet_amount" placeholder="Ø§Ù„Ù‚ÙŠÙ…Ø©">
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-main btn-green" onclick="updateBalance('add')">â• Ø´Ø­Ù† ÙÙˆØ±ÙŠ</button>
                    <button class="btn-main btn-danger" onclick="updateBalance('deduct')">â– Ø®ØµÙ… / ØºØ±Ø§Ù…Ø©</button>
                </div>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                <div class="card-title">ğŸŒ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ© (External Requests)</div>
                <button class="action-btn" onclick="refreshData()" title="ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">ğŸ”„</button>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                            <th>Ø§Ù„Ø³ÙŠØ§Ø±Ø©</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                        </tr>
                    </thead>
                    <tbody id="requests-body">
                        <tr><td colspan="5" style="text-align:center;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card card-full">
            <div class="card-header">
                <div class="card-title">ğŸ‘®â€â™‚ï¸ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø· (Active Fleet)</div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <span style="color:var(--text-light); font-size:12px; font-weight:bold;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø±ØµÙŠØ¯: <b style="color:var(--success); font-size:14px;" id="total-fleet-bal">0.00</b></span>
                    <input type="text" id="search-active" placeholder="Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹..." oninput="renderFleet()" style="width:200px; padding:8px; border:1px solid #cbd5e1;">
                </div>
            </div>
            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            <th>Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„ØªÙ‚ÙŠÙŠÙ…)</th>
                            <th>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Code/Tel)</th>
                            <th>Ø§Ù„Ø±ØµÙŠØ¯</th>
                            <th>Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</th>
                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th>ØªØ­ÙƒÙ… Ø´Ø§Ù…Ù„</th>
                        </tr>
                    </thead>
                    <tbody id="fleet-body">
                        <tr><td colspan="6" style="text-align:center; padding:30px; color:#94a3b8;">Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† ØºØ±ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <div id="merchant-sim" style="display:none; position:fixed; bottom:20px; right:20px; background:white; padding:25px; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,0.2); z-index:1500; width:320px; border:3px solid var(--gold);">
        <h3 style="color:var(--primary); margin-top:0; text-align:center;">ğŸª Ù†Ù‚Ø·Ø© Ø´Ø­Ù† (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
        <input type="text" id="merch-cap-input" placeholder="ÙƒÙˆØ¯ Ø§Ù„ÙƒØ§Ø¨ØªÙ†" style="background:#f1f5f9; color:black; margin-bottom:10px; width:100%; padding:12px;">
        <input type="number" id="merch-amount-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" style="background:#f1f5f9; color:black; margin-bottom:15px; width:100%; padding:12px;">
        <button onclick="merchantCharge()" style="width:100%; padding:12px; background:var(--gold); border:none; border-radius:10px; font-weight:bold; cursor:pointer; color:white; font-size:16px;">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø´Ø­Ù† âœ…</button>
        <button onclick="toggleMerchantSim()" style="width:100%; padding:8px; margin-top:10px; background:none; border:none; color:var(--danger); cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>

    <div id="report-modal">
        <div class="report-paper">
            <div style="text-align:center; border-bottom:3px solid var(--primary); padding-bottom:20px; margin-bottom:30px;">
                <h1 style="margin:0; font-size:32px; color:var(--primary);">N <span style="color:#d4af37">One</span> Global Systems</h1>
                <h3 style="margin:5px 0; color:#64748b;">ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù„Ù„ÙƒØ§Ø¨ØªÙ† (Captain Full Dossier)</h3>
                <p style="font-size:12px; color:#94a3b8;">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <span id="rep-date"></span></p>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:30px; background:#f8fafc; padding:25px; border-radius:12px; border:1px solid #e2e8f0;">
                <div>
                    <h4 style="margin:0 0 10px 0; color:var(--primary);">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ø¨ØªÙ†:</h4>
                    <strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="rep-name">---</span><br>
                    <strong>Ø§Ù„ØªØ±Ù…ÙŠØ²:</strong> <span id="rep-code">---</span><br>
                    <strong>Ø§Ù„Ù‡Ø§ØªÙ:</strong> <span id="rep-phone">---</span><br>
                    <strong>Ø§Ù„Ù…Ø±ÙƒØ¨Ø©:</strong> <span id="rep-car">---</span>
                </div>
                <div style="text-align:left;">
                    <h4 style="margin:0 0 10px 0; color:var(--primary);">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø§Ù„ÙŠ:</h4>
                    <strong>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ:</strong> <span id="rep-balance" style="font-size:22px; font-weight:bold; color:var(--success);">0.00</span> Ø¯.Ø£<br>
                    <strong>Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø¹Ø§Ù…:</strong> <span id="rep-stars">â­â­â­â­â­</span><br>
                    <strong>Ø­Ø§Ù„Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦:</strong> <span id="rep-emerg">Ù…ØªØ§Ø­</span>
                </div>
            </div>

            <h4 style="border-bottom:2px solid #e2e8f0; padding-bottom:10px; color:var(--primary);">Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ§Øª ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª:</h4>
            <table style="width:100%; border:1px solid #e2e8f0; color:black; margin-bottom:30px;">
                <thead style="background:#f1f5f9;">
                    <tr>
                        <th style="color:#475569; border:1px solid #cbd5e1; padding:12px;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="color:#475569; border:1px solid #cbd5e1; padding:12px;">Ø§Ù„Ù†ÙˆØ¹</th>
                        <th style="color:#475569; border:1px solid #cbd5e1; padding:12px;">Ø§Ù„Ù…ÙˆÙ‚Ø¹ / Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
                        <th style="color:#475569; border:1px solid #cbd5e1; padding:12px;">Ø§Ù„Ù‚ÙŠÙ…Ø©</th>
                    </tr>
                </thead>
                <tbody id="rep-body"></tbody>
            </table>

            <div style="margin-top:60px; display:flex; justify-content:space-between; align-items:end;">
                <div>
                    <hr style="width:250px; margin-bottom:10px; border-color:#000;">
                    <small style="font-weight:bold;">ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</small>
                </div>
                <div style="text-align:center; border:3px solid #d4af37; padding:10px 30px; color:#d4af37; font-weight:900; transform:rotate(-5deg); opacity:0.9; font-size:18px;">
                    N One Approved<br>âœ… OFFICIAL
                </div>
            </div>

            <button class="no-print btn-main" onclick="window.print()" style="position:absolute; top:20px; right:20px; background:var(--primary); width:auto;">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
            <button class="no-print btn-main" onclick="closeReport()" style="position:absolute; top:20px; right:180px; background:var(--danger); width:auto;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
    </div>

    <script>
        // ========================================================
        // Ø§Ù„Ø¹Ù‚Ù„ Ø§Ù„Ù…Ø¯Ø¨Ø± Ù„Ù„ÙƒØ¨Ø§ØªÙ† v11.0 (Diamond Light Edition) ğŸ§ 
        // ========================================================
        
        if (typeof N_ONE_CORE !== 'undefined') {
            N_ONE_CORE.API_URL = "https://script.google.com/macros/s/AKfycbybaX1dgu-rVIkUAz2w6H2NdYIuv3zKkmPbHON8NTRclD3H6cVgyW5SAzFfAPNcMt6g/exec";
        }

        let allData = [];
        let captains = [];
        let requests = [];
        let orders = [];
        let currentWalletCap = null;

        window.onload = async function() {
            await refreshData();
            // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            setInterval(refreshDataSilent, 30000);
        };

        async function refreshData() {
            showLoading(true);
            try {
                allData = await N_ONE_CORE.fetchData('read');
                processData();
            } catch (e) { console.error(e); }
            showLoading(false);
        }

        async function refreshDataSilent() {
            try {
                allData = await N_ONE_CORE.fetchData('read');
                processData();
            } catch (e) { console.error(e); }
        }

        function processData() {
            captains = allData.filter(i => i.type === 'captain' && i.status !== 'pending').reverse();
            requests = allData.filter(i => i.type === 'captain' && i.status === 'pending');
            orders = allData.filter(i => i.type === 'order'); 
            
            renderRequests();
            renderFleet();
            updateTotalBalance();
        }

        // 1. ØªØ³Ø¬ÙŠÙ„ ÙŠØ¯ÙˆÙŠ (Smart Check)
        async function registerCaptain() {
            const name = document.getElementById('new_cap_name').value;
            const phone = document.getElementById('new_cap_phone').value;
            const code = document.getElementById('new_cap_code').value;
            const car = document.getElementById('new_cap_car').value;
            const model = document.getElementById('new_cap_model').value;
            
            if(!name || !phone || !code) return alert("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!");

            // ÙØ­Øµ Ø§Ù„ØªÙƒØ±Ø§Ø± (Anti-Duplicate)
            const exists = captains.some(c => c.user === code || c.cap_phone === phone);
            if (exists) {
                alert("â›” ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ† (Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„ØªØ±Ù…ÙŠØ²) Ù…Ø³Ø¬Ù„ Ù„Ø¯ÙŠÙ†Ø§ Ù…Ø³Ø¨Ù‚Ø§Ù‹!");
                return;
            }

            showLoading(true);
            const newCap = {
                id: "CAP_" + Date.now(),
                user: code,
                pass: "123456",
                name: name,
                role: "captain",
                type: "captain", 
                cap_phone: phone,
                status: "active",
                pickup: `${car} ${model}`, 
                balance: "0",
                emergency_used: "false",
                expiry: "2030-01-01"
            };

            await N_ONE_CORE.postData('add', [newCap]);
            alert("ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØ§Ø¹ØªÙ…Ø§Ø¯Ù‡ âœ…");
            await refreshData();
            
            document.getElementById('new_cap_name').value = '';
            document.getElementById('new_cap_code').value = '';
            document.getElementById('new_cap_phone').value = '';
            document.getElementById('new_cap_car').value = '';
            document.getElementById('new_cap_model').value = '';
            showLoading(false);
        }

        // 2. Ø§Ù„Ù…Ø­ÙØ¸Ø© (Live Update)
        function searchWallet() {
            const q = document.getElementById('wallet_search').value.toLowerCase();
            const cap = captains.find(c => c.user.toLowerCase() === q || c.cap_phone.includes(q));
            
            if(cap) {
                currentWalletCap = cap;
                document.getElementById('wallet-info').style.display = 'block';
                document.getElementById('w_name').innerText = cap.name;
                document.getElementById('w_balance').innerText = parseFloat(cap.balance || 0).toFixed(2) + " Ø¯.Ø£";
                document.getElementById('w_code').innerText = cap.user;
                document.getElementById('w_phone').innerText = cap.cap_phone;
            } else {
                alert("ÙƒØ§Ø¨ØªÙ† ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ âŒ");
                document.getElementById('wallet-info').style.display = 'none';
                currentWalletCap = null;
            }
        }

        async function updateBalance(action) {
            if(!currentWalletCap) return;
            const val = parseFloat(document.getElementById('wallet_amount').value);
            if(!val) return;

            const oldBal = parseFloat(currentWalletCap.balance || 0);
            const newBal = action === 'add' ? oldBal + val : oldBal - val;

            if(confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯: ${newBal.toFixed(2)} Ø¯.Ø£ ØŸ`)) {
                showLoading(true);
                // Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙÙˆØ±ÙŠ (Optimistic UI)
                currentWalletCap.balance = newBal;
                document.getElementById('w_balance').innerText = newBal.toFixed(2) + " Ø¯.Ø£";
                renderFleet();
                updateTotalBalance();

                await N_ONE_CORE.postData('update', { user: currentWalletCap.user, data: { balance: newBal } });
                
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±ØµÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ ğŸ’°");
                document.getElementById('wallet_amount').value = '';
                showLoading(false);
            }
        }

        function toggleTransfer() {
            const status = document.getElementById('transfer-toggle').checked;
            localStorage.setItem('nOne_cap_transfer', status);
            alert(status ? "ØªÙ… ØªÙØ¹ÙŠÙ„ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ø¨ÙŠÙ† Ø§Ù„ÙƒØ¨Ø§ØªÙ†" : "ØªÙ… Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ØªØ­ÙˆÙŠÙ„");
        }

        // 3. Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆÙŠØ¨
        function renderRequests() {
            const tbody = document.getElementById('requests-body');
            if(requests.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:#94a3b8; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
                return;
            }
            tbody.innerHTML = '';
            requests.forEach(req => {
                tbody.innerHTML += `
                    <tr>
                        <td><strong>${req.name}</strong></td>
                        <td>${req.cap_phone}</td>
                        <td>${req.pickup || '-'}</td>
                        <td><span class="badge bg-pending">Ø§Ù†ØªØ¸Ø§Ø±</span></td>
                        <td>
                            <button class="action-btn" style="color:var(--success);" onclick="approveReq('${req.user}')" title="Ù…ÙˆØ§ÙÙ‚Ø©">âœ…</button>
                            <button class="action-btn" style="color:var(--danger);" onclick="deleteCaptain('${req.user}')" title="Ø±ÙØ¶ ÙˆØ­Ø°Ù">âŒ</button>
                        </td>
                    </tr>
                `;
            });
        }

        async function approveReq(user) {
            if(confirm("Ù‚Ø¨ÙˆÙ„ Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙÙŠ Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ØŸ")) {
                showLoading(true);
                await N_ONE_CORE.postData('update', { user: user, data: { status: 'active', balance: '0' } }); 
                await refreshData();
                showLoading(false);
            }
        }

        // 4. Ø§Ù„Ø£Ø³Ø·ÙˆÙ„ Ø§Ù„Ù†Ø´Ø·
        function renderFleet() {
            const tbody = document.getElementById('fleet-body');
            const q = document.getElementById('search-active').value.toLowerCase();
            tbody.innerHTML = '';

            captains.forEach(cap => {
                if(q && !cap.name.toLowerCase().includes(q) && !cap.user.toLowerCase().includes(q)) return;

                let stars = 'â­â­â­';
                if(parseFloat(cap.balance) > 50) stars = 'â­â­â­â­â­';

                const emergBadge = (cap.emergency_used === 'true') 
                    ? '<span style="color:var(--danger); font-size:10px;">Ù…Ø³ØªÙ†ÙØ° âš ï¸</span>' 
                    : '<span style="color:var(--success); font-size:10px;">Ù…ØªØ§Ø­ âœ…</span>';

                const statusBadge = cap.status === 'active' 
                    ? '<span class="badge bg-active">Ù†Ø´Ø·</span>' 
                    : '<span class="badge bg-paused">Ù…Ø¬Ù…Ø¯</span>';
                
                const freezeIcon = cap.status === 'active' ? 'â„ï¸' : 'â–¶ï¸';
                const freezeColor = cap.status === 'active' ? 'var(--warning)' : 'var(--success)';

                tbody.innerHTML += `
                    <tr>
                        <td>
                            <div style="font-weight:bold; color:var(--primary);">${cap.name}</div>
                            <div style="font-size:10px; color:var(--warning);">${stars}</div>
                        </td>
                        <td style="color:var(--text-light); font-family:monospace;">${cap.user}<br>${cap.cap_phone}</td>
                        <td style="font-weight:bold; font-size:15px; color:var(--success);">${parseFloat(cap.balance||0).toFixed(2)}</td>
                        <td>${emergBadge}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <button class="action-btn" onclick="openReport('${cap.user}')" title="ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„" style="color:var(--primary);">ğŸ–¨ï¸</button>
                            <button class="action-btn" onclick="freezeCap('${cap.user}')" style="color:${freezeColor};" title="ØªØ¬Ù…ÙŠØ¯/ØªÙØ¹ÙŠÙ„">${freezeIcon}</button>
                            <button class="action-btn" onclick="deleteCaptain('${cap.user}')" style="color:var(--danger);" title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ">ğŸ—‘ï¸</button>
                        </td>
                    </tr>
                `;
            });
        }

        function updateTotalBalance() {
            const total = captains.reduce((sum, c) => sum + parseFloat(c.balance || 0), 0);
            document.getElementById('total-fleet-bal').innerText = total.toFixed(2) + " Ø¯.Ø£";
        }

        async function freezeCap(user) {
            const cap = captains.find(c => c.user === user);
            if(!cap) return;
            const newStatus = cap.status === 'active' ? 'paused' : 'active';
            
            if(confirm(`ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ø¥Ù„Ù‰ ${newStatus === 'active' ? 'Ù†Ø´Ø·' : 'Ù…Ø¬Ù…Ø¯'}ØŸ`)) {
                showLoading(true);
                // ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ
                cap.status = newStatus;
                renderFleet();
                await N_ONE_CORE.postData('update', { user: user, data: { status: newStatus } });
                showLoading(false);
            }
        }

        async function deleteCaptain(user) {
            if(confirm("âš ï¸ ØªØ­Ø°ÙŠØ±: Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø¨ØªÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
                showLoading(true);
                captains = captains.filter(c => c.user !== user); // Ø­Ø°Ù Ù…Ø­Ù„ÙŠ ÙÙˆØ±ÙŠ
                renderFleet();
                updateTotalBalance();
                await N_ONE_CORE.fetchData('delete', { user: user });
                alert("ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒØ§Ø¨ØªÙ† ÙˆØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø³Ø¬Ù„ ğŸ—‘ï¸");
                showLoading(false);
            }
        }

        // 5. Ø§Ù„ØªÙ‚Ø±ÙŠØ±
        function openReport(user) {
            const cap = captains.find(c => c.user === user);
            if(!cap) return;

            document.getElementById('rep-name').innerText = cap.name;
            document.getElementById('rep-code').innerText = cap.user;
            document.getElementById('rep-phone').innerText = cap.cap_phone;
            document.getElementById('rep-car').innerText = cap.pickup || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            document.getElementById('rep-balance').innerText = parseFloat(cap.balance || 0).toFixed(2);
            document.getElementById('rep-emerg').innerText = cap.emergency_used === 'true' ? "Ù…Ø³ØªÙ†ÙØ°" : "Ù…ØªØ§Ø­";
            document.getElementById('rep-date').innerText = new Date().toLocaleDateString();

            const tbody = document.getElementById('rep-body');
            tbody.innerHTML = '';
            
            const myOrders = orders.filter(o => o.cap_name === cap.name || o.cap_phone === cap.cap_phone);

            if(myOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ÙƒØ§Ø¨ØªÙ†</td></tr>';
            } else {
                myOrders.forEach(o => {
                    tbody.innerHTML += `
                        <tr>
                            <td style="border:1px solid #ddd; padding:8px;">${o.date.split('T')[0]}</td>
                            <td style="border:1px solid #ddd; padding:8px;">ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨</td>
                            <td style="border:1px solid #ddd; padding:8px;">${o.pickup}</td>
                            <td style="border:1px solid #ddd; padding:8px;">${o.fee} Ø¯.Ø£</td>
                        </tr>
                    `;
                });
            }

            document.getElementById('report-modal').style.display = 'flex';
        }

        function closeReport() { document.getElementById('report-modal').style.display = 'none'; }

        // 6. Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªØ§Ø¬Ø±
        function toggleMerchantSim() {
            const el = document.getElementById('merchant-sim');
            el.style.display = el.style.display === 'none' ? 'block' : 'none';
        }

        async function merchantCharge() {
            const code = document.getElementById('merch-cap-input').value;
            const amt = parseFloat(document.getElementById('merch-amount-input').value);
            
            const cap = captains.find(c => c.user === code);
            if(cap && amt) {
                if(confirm(`Ø´Ø­Ù† ${amt} Ø¯.Ø£ Ù„Ù„ÙƒØ§Ø¨ØªÙ† ${cap.name}ØŸ`)) {
                    showLoading(true);
                    const newBal = parseFloat(cap.balance || 0) + amt;
                    await N_ONE_CORE.postData('update', { user: cap.user, data: { balance: newBal } });
                    cap.balance = newBal;
                    renderFleet();
                    alert("ØªÙ… Ø§Ù„Ø´Ø­Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ…");
                    toggleMerchantSim();
                    showLoading(false);
                }
            } else {
                alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©");
            }
        }

        function showLoading(show) {
            document.getElementById('loading-bar').style.width = show ? '100%' : '0%';
        }
    </script>
</body>
</html>
